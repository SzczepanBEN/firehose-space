---
export interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  ogImage?: string;
  noIndex?: boolean;
}

const { title, description = "Firehose.space - Open publishing platform for links and articles", canonicalUrl, ogImage, noIndex = false } = Astro.props;

const fullTitle = title === "Firehose" ? title : `${title} | Firehose`;
const siteUrl = "https://firehose.space";
const defaultOgImage = title === "Firehose" ? `${siteUrl}/api/og/homepage` : `${siteUrl}/og-image.png`;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content={description} />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="generator" content={Astro.generator} />
  
  <title>{fullTitle}</title>
  
  <!-- Canonical URL -->
  {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
  
  <!-- Open Graph -->
  <meta property="og:title" content={fullTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={ogImage || defaultOgImage} />
  <meta property="og:url" content={canonicalUrl || siteUrl} />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Firehose" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={fullTitle} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={ogImage || defaultOgImage} />
  
  <!-- SEO -->
  {noIndex && <meta name="robots" content="noindex, nofollow" />}
  
  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="Firehose RSS Feed" href="/rss.xml" />
  
  <!-- Preconnect to external domains -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Schema.org structured data -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Firehose",
      "url": "https://firehose.space",
      "description": "Open publishing platform for links and articles",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://firehose.space/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
  </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">
  <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center">
          <a href="/" class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-xl font-bold text-gray-900 dark:text-white">Firehose</span>
          </a>
        </div>

        <!-- Navigation -->
        <nav class="hidden md:flex items-center space-x-8">
          <a href="/" class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400">Home</a>
          <a href="/new" class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400">New</a>
          <a href="/top" class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400">Top</a>
          <a href="/leaderboard" class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400">Authors</a>
          <a href="/api" class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400">API</a>
        </nav>

        <!-- User menu -->
        <div class="flex items-center space-x-4">
          <a 
            href="/submit" 
            class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
          >
            Submit
          </a>
          
          <!-- Auth buttons -->
          <div id="auth-buttons" class="hidden">
            <button 
              id="login-btn"
              class="text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 text-sm font-medium"
            >
              Login
            </button>
          </div>
          
          <div id="user-menu" class="hidden">
            <div class="relative">
              <button 
                id="user-menu-btn"
                class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400"
              >
                <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User avatar">
                <span id="user-name"></span>
                <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
              
              <!-- Dropdown menu -->
              <div 
                id="user-dropdown" 
                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 z-50"
              >
                <div class="py-1">
                  <a id="user-profile-link" href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Your Profile
                  </a>
                  <hr class="border-gray-200 dark:border-gray-700">
                  <button 
                    id="logout-btn"
                    class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <slot />
  </main>

  <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div class="col-span-1 md:col-span-2">
          <div class="flex items-center space-x-2 mb-4">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-xl font-bold">Firehose</span>
          </div>
          <p class="text-gray-600 dark:text-gray-400 max-w-md">
            Open publishing platform where anyone can share links and articles. No gatekeeping, just pure content flow.
          </p>
        </div>
        
        <div>
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4">Platform</h3>
          <ul class="space-y-2">
            <li><a href="/about" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">About</a></li>
            <li><a href="/guidelines" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">Guidelines</a></li>
            <li><a href="/api" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">API Docs</a></li>
            <li><a href="/rss.xml" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">RSS Feed</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4">Legal</h3>
          <ul class="space-y-2">
            <li><a href="/terms" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">Terms of Service</a></li>
            <li><a href="/privacy" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">Privacy Policy</a></li>
            <li><a href="/dmca" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">DMCA</a></li>
            <li><a href="/contact" class="text-gray-600 dark:text-gray-400 hover:text-orange-600 dark:hover:text-orange-400">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-center text-gray-500 dark:text-gray-400 text-sm">
          Â© {new Date().getFullYear()} Firehose.space. Built with ðŸ”¥ and hosted on Cloudflare.
        </p>
      </div>
    </div>
  </footer>

  <!-- Auth & UI JavaScript -->
  <script>
    // Simple auth state management
    const authState = {
      user: null,
      isLoggedIn: false
    };

    // Check for existing session on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuthStatus();
    });

    async function checkAuthStatus() {
      try {
        const authToken = localStorage.getItem('auth_token');
        if (!authToken) {
          authState.isLoggedIn = false;
          updateAuthUI();
          return;
        }

        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          authState.user = user;
          authState.isLoggedIn = true;
          updateAuthUI();
        } else {
          // Token is invalid, remove it
          localStorage.removeItem('auth_token');
          authState.isLoggedIn = false;
          updateAuthUI();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('auth_token');
        authState.isLoggedIn = false;
        updateAuthUI();
      }
    }

    function updateAuthUI() {
      const authButtons = document.getElementById('auth-buttons');
      const userMenu = document.getElementById('user-menu');
      const loginBtn = document.getElementById('login-btn');
      
      if (authState.isLoggedIn && authState.user) {
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userProfileLink = document.getElementById('user-profile-link');
        
        userAvatar.src = authState.user.avatar_url || '/default-avatar.svg';
        userName.textContent = authState.user.display_name;
        userProfileLink.href = `/u/${authState.user.id}`;
      } else {
        authButtons.classList.remove('hidden');
        userMenu.classList.add('hidden');
      }
    }

    // Login handler
    document.getElementById('login-btn')?.addEventListener('click', () => {
      window.location.href = '/login';
    });

    // User dropdown toggle
    document.getElementById('user-menu-btn')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = document.getElementById('user-dropdown');
      dropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      const dropdown = document.getElementById('user-dropdown');
      if (!dropdown.classList.contains('hidden')) {
        dropdown.classList.add('hidden');
      }
    });

    // Logout handler
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      try {
        // Clear local storage
        localStorage.removeItem('auth_token');
        
        // Reset auth state
        authState.user = null;
        authState.isLoggedIn = false;
        
        // Update UI
        updateAuthUI();
        
        // Redirect to homepage
        window.location.href = '/';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    });

    // Global auth helper function
    window.isAuthenticated = () => {
      return authState.isLoggedIn;
    };

    window.getAuthToken = () => {
      return localStorage.getItem('auth_token');
    };
  </script>
</body>
</html>
